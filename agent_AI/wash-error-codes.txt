# âœ… Gestraf-Aligned Error Codes â€“ SUMISAN Wash Management

This document maps each API endpoint and error code to its corresponding **CQRS command or query handler**.

All business rule validations and exceptions are handled within **Handlers** (not controllers), and return consistent HTTP codes using middleware or controller-level result mapping.

---

## ğŸ” Authentication

### `POST /api/auth/login`

* **Handler:** `AuthenticateUserCommand`
* **Errors:**

  * `400 Bad Request` â†’ Missing fields (validated by `LoginRequestValidator`)
  * `401 Unauthorized` â†’ Invalid credentials (thrown in Handler)

---

## ğŸš¿ Start Wash

### `POST /api/washing`

* **Handler:** `StartWashCommand`
* **Errors:**

  * `400 Bad Request` â†’ Missing `MachineId`, `StartUserId`, or empty `ProtEntries[]`
  * `409 Conflict` â†’

    * Max 2 active washes (enforced via `IWashingRepository.CountActiveAsync()`)
    * Selected machine already in use (via `IWashingRepository.IsMachineInUseAsync()`)

---

## ğŸ§º Finish Wash

### `PUT /api/washing/{id}/finish`

* **Handler:** `FinishWashCommand`
* **Errors:**

  * `400 Bad Request` â†’ DTO validation failure (missing `EndUserId`)
  * `403 Forbidden` â†’ No photos uploaded for this wash (checked via `IPhotoRepository.GetByWashId()`)
  * `404 Not Found` â†’ Wash does not exist (null from `IWashingRepository.GetByIdAsync()`)
  * `409 Conflict` â†’ Wash is already finished (Status = 'F')

---

## ğŸ“¦ Add Prot

### `POST /api/washing/{id}/prots`

* **Handler:** `AddProtCommand`
* **Errors:**

  * `400 Bad Request` â†’ Invalid prot format (validator-level)
  * `404 Not Found` â†’ Wash not found (repository returns null)
  * `409 Conflict` â†’ Wash is already finished (Status = 'F')

---

## ğŸ–¼ Upload Photo

### `POST /api/washing/{id}/photos`

* **Handler:** `UploadPhotoCommand`
* **Errors:**

  * `400 Bad Request` â†’ No file provided or unsupported format (handler or `PhotoUploadValidator`)
  * `404 Not Found` â†’ Wash not found
  * `409 Conflict` â†’ Already reached 99 photos (business rule)
  * `413 Payload Too Large` â†’ File exceeds size limit (enforced via request limit config)

---

## ğŸ” Get Active Washes

### `GET /api/washing/active`

* **Handler:** `GetActiveWashesQuery`
* **Errors:**

  * `200 OK` â†’ Always returns 0â€“2 items (no failure cases)

---

## ğŸ” Get Wash By ID

### `GET /api/washing/{id}`

* **Handler:** `GetWashByIdQuery`
* **Errors:**

  * `404 Not Found` â†’ ID does not match any existing wash

---

## ğŸ” Global Auth Errors

* `401 Unauthorized` â†’ Missing or invalid JWT (middleware)
* `403 Forbidden` â†’ Authenticated but lacking required role (e.g., not `WarehouseUser`)
* `500 Internal Server Error` â†’ Unexpected exception (handled via middleware + Serilog)

---

## âœ… Handler-Based Error Principles (Gestraf)

* **Validation errors** (e.g., missing fields) are enforced via FluentValidation
* **Business rules** (e.g., max washes, photo count) are checked inside handlers
* **NotFound/Conflict/Forbidden** errors are thrown by handlers, mapped via exception middleware or result helpers

This keeps all error behavior declarative, testable, and in line with Gestrafâ€™s CQRS and MediatR-based design.
